<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New Quality Issue</title>
    <style>
        body { 
            background-color: lightblue; 
            font-family: 'Montserrat', sans-serif; 
            font-size: 14px; 
            display: flex; 
        }
        .sidebar { 
            width: 200px; 
            background-color: #333; 
            color: white; 
            padding: 15px; 
            overflow-y: auto; 
            height: 100vh; 
            position: fixed; 
        }
        .sidebar button { 
            display: block; 
            width: 100%; 
            padding: 10px; 
            margin: 5px 0; 
            background-color: #444; 
            border: none; 
            color: white; 
            cursor: pointer; 
            font-size: 14px; 
            text-align: left; 
        }
        .sidebar button:hover { 
            background-color: #555; 
        }
        .content { 
            margin-left: 220px; 
            padding: 20px; 
            width: 100%; 
        }
        .section { 
            display: none; 
        }
        .section.active { 
            display: block; 
        }
        label { 
            display: block; 
            margin-top: 10px; 
        }
        select, input, textarea { 
            margin-bottom: 10px; 
            padding: 5px; 
            font-family: 'Montserrat', sans-serif; 
            font-size: 14px; 
            width: 50%; 
        }
        button[type="submit"] { 
            padding: 10px 15px; 
            background-color: #007BFF; 
            color: white; 
            border: none; 
            cursor: pointer; 
            font-family: 'Montserrat', sans-serif; 
            font-size: 14px; 
        }
        button[type="submit"]:hover { 
            background-color: #0056b3; 
        }
        .universal-header { 
            background-color: #eee; 
            padding: 10px; 
            margin-bottom: 20px; 
            text-align: center; 
            font-size: 16px; 
            border-radius: 5px; 
            font-weight: bold; 
        }
        .dashboard-link { 
            font-size: 8pt; 
            text-align: center; 
            display: block; 
            margin-bottom: 20px; 
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <button onclick="showSection('d1')">D1: Formation of a Problem-Solving Team</button>
        <button onclick="showSection('d2')">D2: Problem description</button>
        <button onclick="showSection('d3')">D3: Containment action</button>
        <button onclick="showSection('d4')">D4: Root cause analysis</button>
        <button onclick="showSection('d5')">D5: Potential corrective action</button>
        <button onclick="showSection('d6')">D6: Implement corrective action</button>
        <button onclick="showSection('d7')">D7: Take preventive action</button>
        <button onclick="showSection('d8')">D8: Read Across & Lessons Learned</button>
    </div>

    <div class="content">
        <a href="/" class="dashboard-link">Back to AMP board</a>

        <div class="universal-header">
            AMP#: <%= carNumber ? carNumber : 'Not yet created' %> | Issue Creator: <%= issueCreatorName %>
        </div>

        <div id="d1" class="section">
            <h2>D1: Formation of a Problem-Solving Team</h2>
            <form action="<%= car ? `/save-section/${car._id}/d1` : '/save-section/new/d1' %>" method="POST">
                <!-- Root Cause Champion -->
                <div>
                    <label for="root_cause_champion">Root Cause Champion:</label>
                    <input type="text" id="root_cause_champion" name="d1[root_cause_champion]" value="<%= car && car.d1 ? car.d1.root_cause_champion : '' %>" placeholder="Enter first and last name" required>
                </div>

                <!-- HOD Responsible -->
                <div>
                    <label for="hod_responsible">HOD Responsible:</label>
                    <input type="text" id="hod_responsible" name="d1[hod_responsible]" value="<%= car && car.d1 ? car.d1.hod_responsible : '' %>" placeholder="Enter first and last name" required>
                </div>

                <!-- Support Role -->
                <div>
                    <label for="support_role">Support Role:</label>
                    <input type="text" id="support_role" name="d1[support_role]" value="<%= car && car.d1 ? car.d1.support_role : '' %>" placeholder="Enter first and last name" required>
                </div>

                <!-- Issue Creator -->
                <div>
                    <label for="issue_creator">Issue Creator:</label>
                    <input type="text" id="issue_creator" name="d1[issue_creator]" value="<%= car && car.d1 ? car.d1.issue_creator : '' %>" placeholder="Enter first and last name" required>
                </div>

                <!-- CAR System Tracker -->
                <div>
                    <label for="car_system_tracker">CAR System Tracker:</label>
                    <input type="text" id="car_system_tracker" name="d1[car_system_tracker]" value="<%= car && car.d1 ? car.d1.car_system_tracker : '' %>" placeholder="Enter first and last name" required>
                </div>

                <!-- Option to add more team members -->
                <div id="additional_members"></div>
                <button type="button" onclick="addMember()">Add Another Member (Optional)</button>

                <!-- Save Button -->
                <button type="submit" name="action" value="save">Save</button>

                <!-- Pull CAR# / Create Button -->
                <button type="submit" name="action" value="create-car">Pull CAR# / Create</button>
            </form>
        </div>

        <div id="d2" class="section">
            <h2>D2: Problem description</h2>
            <form action="<%= car ? `/save-section/${car._id}/d2` : '/save-section/new/d2' %>" method="POST" enctype="multipart/form-data">
                <!-- Vehicle Model -->
                <div>
                    <label for="vehicle_model">Vehicle Model:</label>
                    <select id="vehicle_model" name="d2[vehicle_model]" required>
                        <option value="NQ5a" <%= car && car.d2 && car.d2.vehicle_model === 'NQ5a' ? 'selected' : '' %>>NQ5a</option>
                        <option value="MQ4a" <%= car && car.d2 && car.d2.vehicle_model === 'MQ4a' ? 'selected' : '' %>>MQ4a</option>
                        <option value="MV1a" <%= car && car.d2 && car.d2.vehicle_model === 'MV1a' ? 'selected' : '' %>>MV1a</option>
                        <option value="ON" <%= car && car.d2 && car.d2.vehicle_model === 'ON' ? 'selected' : '' %>>ON</option>
                    </select>
                </div>

                <!-- Issue Title -->
                <div>
                    <label for="issue_title">Issue Title:</label>
                    <input type="text" id="issue_title" name="d2[issue_title]" value="<%= car && car.d2 ? car.d2.issue_title : '' %>" required>
                </div>

                <!-- KPI -->
                <div>
                    <label for="kpi">KPI:</label>
                    <select id="kpi" name="d2[kpi]" required>
                        <option value="FTTQ" <%= car && car.d2 && car.d2.kpi === 'FTTQ' ? 'selected' : '' %>>FTTQ</option>
                        <option value="Line Call" <%= car && car.d2 && car.d2.kpi === 'Line Call' ? 'selected' : '' %>>Line Call</option>
                        <option value="Dealer Claim" <%= car && car.d2 && car.d2.kpi === 'Dealer Claim' ? 'selected' : '' %>>Dealer Claim</option>
                        <option value="3M" <%= car && car.d2 && car.d2.kpi === '3M' ? 'selected' : '' %>>3M</option>
                        <option value="VPC" <%= car && car.d2 && car.d2.kpi === 'VPC' ? 'selected' : '' %>>VPC</option>
                        <option value="Other" <%= car && car.d2 && car.d2.kpi === 'Other' ? 'selected' : '' %>>Other</option>
                    </select>
                </div>

                <!-- Function Group -->
                <div>
                    <label for="function_group">Function Group:</label>
                    <select id="function_group" name="d2[function_group]" required>
                        <option value="Interior" <%= car && car.d2 && car.d2.function_group === 'Interior' ? 'selected' : '' %>>Interior</option>
                        <option value="Exterior" <%= car && car.d2 && car.d2.function_group === 'Exterior' ? 'selected' : '' %>>Exterior</option>
                        <option value="Electrical" <%= car && car.d2 && car.d2.function_group === 'Electrical' ? 'selected' : '' %>>Electrical</option>
                        <option value="Chassis" <%= car && car.d2 && car.d2.function_group === 'Chassis' ? 'selected' : '' %>>Chassis</option>
                        <option value="Body" <%= car && car.d2 && car.d2.function_group === 'Body' ? 'selected' : '' %>>Body</option>
                        <option value="Weld" <%= car && car.d2 && car.d2.function_group === 'Weld' ? 'selected' : '' %>>Weld</option>
                        <option value="Paint" <%= car && car.d2 && car.d2.function_group === 'Paint' ? 'selected' : '' %>>Paint</option>
                        <option value="Other" <%= car && car.d2 && car.d2.function_group === 'Other' ? 'selected' : '' %>>Other</option>
                        <option value="N/A" <%= car && car.d2 && car.d2.function_group === 'N/A' ? 'selected' : '' %>>N/A</option>
                    </select>
                </div>

                <!-- Where Process -->
                <div>
                    <label for="where_process">Where (Process):</label>
                    <input type="text" id="where_process" name="d2[where_process]" value="<%= car && car.d2 ? car.d2.where_process : '' %>">
                </div>

                <!-- Part Name -->
                <div>
                    <label for="part_name">Part Name:</label>
                    <input type="text" id="part_name" name="d2[part_name]" value="<%= car && car.d2 ? car.d2.part_name : '' %>" required>
                </div>

                <!-- Part Number -->
                <div>
                    <label for="part_number">Part Number:</label>
                    <input type="text" id="part_number" name="d2[part_number]" value="<%= car && car.d2 ? car.d2.part_number : '' %>" required>
                </div>

                <!-- Define the Problem -->
                <div>
                    <label for="defect">Define the Problem:</label>
                    <input type="text" id="defect" name="d2[defect]" value="<%= car && car.d2 ? car.d2.defect : '' %>" required>
                </div>

                <!-- What (Green Y/Response/Output) -->
                <div>
                    <label for="green_y">What (Green Y/Response/Output):</label>
                    <input type="text" id="green_y" name="d2[green_y]" value="<%= car && car.d2 ? car.d2.green_y : '' %>" required>
                    <p style="font-size: 12px; color: gray;">
                        The Green Y’s have an accounting metric (i.e., PPH, IPTV, PPM) or an engineering metric (i.e., mm, dB) associated with them.
                    </p>
                </div>

                <!-- When (Problem First Seen) -->
                <div>
                    <label for="problem_seen_date">When (Problem First Seen):</label>
                    <input type="date" id="problem_seen_date" name="d2[problem_seen_date]" value="<%= car && car.d2 ? car.d2.problem_seen_date : '' %>" required>
                </div>

                <!-- When (In Product Life Cycle) -->
                <div>
                    <label for="product_life_cycle">When (In Product Life Cycle):</label>
                    <select id="product_life_cycle" name="d2[product_life_cycle]" required>
                        <option value="DV" <%= car && car.d2 && car.d2.product_life_cycle === 'DV' ? 'selected' : '' %>>DV</option>
                        <option value="PV" <%= car && car.d2 && car.d2.product_life_cycle === 'PV' ? 'selected' : '' %>>PV</option>
                        <option value="Prototype" <%= car && car.d2 && car.d2.product_life_cycle === 'Prototype' ? 'selected' : '' %>>Prototype</option>
                        <option value="T1" <%= car && car.d2 && car.d2.product_life_cycle === 'T1' ? 'selected' : '' %>>T1</option>
                        <option value="T2" <%= car && car.d2 && car.d2.product_life_cycle === 'T2' ? 'selected' : '' %>>T2</option>
                        <option value="Production" <%= car && car.d2 && car.d2.product_life_cycle === 'Production' ? 'selected' : '' %>>Production</option>
                        <option value="Other" <%= car && car.d2 && car.d2.product_life_cycle === 'Other' ? 'selected' : '' %>>Other</option>
                    </select>
                </div>

                <!-- Upload Photos -->
                <div>
                    <label for="photos">Upload Photos:</label>
                    <input type="file" id="photos" name="photos" accept="image/*" multiple onchange="previewPhotos()">
                    <div id="photo-preview" style="margin-top: 10px;"></div>
                </div>

                <!-- Where (In Vehicle) -->
                <div>
                    <label for="in_vehicle">Where (In Vehicle):</label>
                    <input type="text" id="in_vehicle" name="d2[in_vehicle]" value="<%= car && car.d2 ? car.d2.in_vehicle : '' %>" required>
                </div>

                <!-- Where (Side of Vehicle) -->
                <div>
                    <label for="side_of_vehicle">Where (Side of Vehicle):</label>
                    <select id="side_of_vehicle" name="d2[side_of_vehicle]" required>
                        <option value="Left Hand" <%= car && car.d2 && car.d2.side_of_vehicle === 'Left Hand' ? 'selected' : '' %>>Left Hand</option>
                        <option value="Right Hand" <%= car && car.d2 && car.d2.side_of_vehicle === 'Right Hand' ? 'selected' : '' %>>Right Hand</option>
                        <option value="Fore" <%= car && car.d2 && car.d2.side_of_vehicle === 'Fore' ? 'selected' : '' %>>Fore</option>
                        <option value="Aft" <%= car && car.d2 && car.d2.side_of_vehicle === 'Aft' ? 'selected' : '' %>>Aft</option>
                        <option value="+H" <%= car && car.d2 && car.d2.side_of_vehicle === '+H' ? 'selected' : '' %>>+H</option>
                        <option value="-H" <%= car && car.d2 && car.d2.side_of_vehicle === '-H' ? 'selected' : '' %>>-H</option>
                    </select>
                </div>

                <!-- Where (Additional) -->
                <div>
                    <label for="additional_where">Where (Additional):</label>
                    <input type="text" id="additional_where" name="d2[additional_where]" value="<%= car && car.d2 ? car.d2.additional_where : '' %>">
                </div>

                <!-- Save Button -->
                <button type="submit" name="action" value="save">Save</button>
            </form>
        </div>

        <!-- D3 Section: Containment Action -->
        <div id="d3" class="section">
            <h2>D3: Containment Action</h2>
            <form action="<%= car ? `/save-section/${car._id}/d3` : '/save-section/new/d3' %>" method="POST" enctype="multipart/form-data">
                <!-- Recall Parts that Recently Shipped -->
                <div>
                    <label for="recall_parts_notes">Recall Parts that Recently Shipped:</label>
                    <input type="text" id="recall_parts_notes" name="d3[recall_parts_notes]" value="<%= car && car.d3 ? car.d3.recall_parts_notes : '' %>" placeholder="Notes or more info">
                </div>

                <!-- Stop parts in shipping department -->
                <div>
                    <label for="shipping_department_notes">Stop Parts in Shipping Department:</label>
                    <input type="text" id="shipping_department_notes" name="d3[shipping_department_notes]" value="<%= car && car.d3 ? car.d3.shipping_department_notes : '' %>" placeholder="Alert PC Department, Alert GLovis, more details">
                </div>

                <!-- Isolate parts in stock -->
                <div>
                    <label for="isolate_parts">Isolate Parts in Stock:</label>
                    <input type="text" id="isolate_parts" name="d3[isolate_parts]" value="<%= car && car.d3 ? car.d3.isolate_parts : '' %>" placeholder="Add details">
                </div>

                <!-- Issue Alerted to Final Inspection -->
                <div>
                    <label for="final_inspection_notes">Issue Alerted to Final Inspection:</label>
                    <input type="text" id="final_inspection_notes" name="d3[final_inspection_notes]" value="<%= car && car.d3 ? car.d3.final_inspection_notes : '' %>" placeholder="More info">
                </div>

                <!-- Quarantine between root cause area and final inspection -->
                <div>
                    <label for="quarantine_notes">Quarantine Between Root Cause Area and Final Inspection:</label>
                    <input type="text" id="quarantine_notes" name="d3[quarantine_notes]" value="<%= car && car.d3 ? car.d3.quarantine_notes : '' %>" placeholder="More detail">
                </div>

                <!-- Sort - Part Sort/Yard Sweep -->
                <div>
                    <label for="sort_notes">Sort - Part Sort / Yard Sweep:</label>
                    <input type="text" id="sort_notes" name="d3[sort_notes]" value="<%= car && car.d3 ? car.d3.sort_notes : '' %>" placeholder="More detail">
                </div>
                <!-- Add the rest of the fields similarly -->

                <div>
                    <h3>Number of Parts Sorted</h3>
                    <label for="parts_sorted_qty">Qty:</label>
                    <input type="number" id="parts_sorted_qty" name="d3[parts_sorted_qty]" value="<%= car && car.d3 ? car.d3.parts_sorted_qty : '' %>">

                    <label for="parts_date_of_check">Date of Check:</label>
                    <input type="date" id="parts_date_of_check" name="d3[parts_date_of_check]" value="<%= car && car.d3 ? car.d3.parts_date_of_check : '' %>">

                    <label for="ok_parts_qty">Number of OK Parts (Qty):</label>
                    <input type="number" id="ok_parts_qty" name="d3[ok_parts_qty]" value="<%= car && car.d3 ? car.d3.ok_parts_qty : '' %>">

                    <label for="ng_parts_qty">Number of NG Parts (Qty):</label>
                    <input type="number" id="ng_parts_qty" name="d3[ng_parts_qty]" value="<%= car && car.d3 ? car.d3.ng_parts_qty : '' %>">

                    <label for="parts_note">Note:</label>
                    <textarea id="parts_note" name="d3[parts_note]" rows="2" placeholder="Additional notes"><%= car && car.d3 ? car.d3.parts_note : '' %></textarea>
                </div>

                <div>
                    <h3>Number of Vehicles Sorted</h3>
                    <label for="vehicles_sorted_qty">Qty:</label>
                    <input type="number" id="vehicles_sorted_qty" name="d3[vehicles_sorted_qty]" value="<%= car && car.d3 ? car.d3.vehicles_sorted_qty : '' %>">

                    <label for="date_begin_sort">Date of Beginning of Sort:</label>
                    <input type="date" id="date_begin_sort" name="d3[date_begin_sort]" value="<%= car && car.d3 ? car.d3.date_begin_sort : '' %>">

                    <label for="date_end_sort">Date of Ending of Sort:</label>
                    <input type="date" id="date_end_sort" name="d3[date_end_sort]" value="<%= car && car.d3 ? car.d3.date_end_sort : '' %>">

                    <label for="ok_body_numbers">Number of OK Body Numbers:</label>
                    <input type="number" id="ok_body_numbers" name="d3[ok_body_numbers]" value="<%= car && car.d3 ? car.d3.ok_body_numbers : '' %>">

                    <label for="ng_body_numbers">Number of NG Body Numbers:</label>
                    <input type="number" id="ng_body_numbers" name="d3[ng_body_numbers]" value="<%= car && car.d3 ? car.d3.ng_body_numbers : '' %>">

                    <label for="vehicles_note">Note:</label>
                    <textarea id="vehicles_note" name="d3[vehicles_note]" rows="2" placeholder="Additional notes"><%= car && car.d3 ? car.d3.vehicles_note : '' %></textarea>
                </div>

                <!-- Upload Sort and Yard Sweep Documents -->
                <div>
                    <label for="sort_docs">Upload Sort/Yard Sweep Documents:</label>
                    <input type="file" id="sort_docs" name="sort_docs" accept=".xlsx,.xls,.csv" multiple>
                </div>

                <!-- PDR Needed -->
                <div>
                    <label for="d3_pdr_needed">PDR Needed:</label>
                    <select name="d3[pdr_needed]" required>
                        <option value="Yes" <%= car && car.d3 && car.d3.pdr_needed === 'Yes' ? 'selected' : '' %>>Yes</option>
                        <option value="No" <%= car && car.d3 && car.d3.pdr_needed === 'No' ? 'selected' : '' %>>No</option>
                    </select>
                </div>

                <!-- PDR Number -->
                <div>
                    <label for="d3_pdr_number">PDR Number (if applicable):</label>
                    <input type="text" name="d3[pdr_number]" value="<%= car && car.d3 ? car.d3.pdr_number : '' %>">
                </div>

                <!-- RESULTS SECTION -->
                <div>
                    <label for="results">Results Section:</label>
                    <textarea id="results" name="d3[results]" rows="4" placeholder="Specific info"><%= car && car.d3 ? car.d3.results : '' %></textarea>
                </div>

                <!-- Save Button -->
                <button type="submit" name="action" value="save">Save</button>
            </form>
        </div>

        <!-- D4 Section: Root Cause Analysis -->
        <div id="d4" class="section">
            <h2>D4: Root Cause Analysis</h2>
            <form action="<%= car ? `/save-section/${car._id}/d4` : '/save-section/new/d4' %>" method="POST" enctype="multipart/form-data">

                <!-- Process Confirmation -->
                <h3>Process Confirmation</h3>

                <div>
                    <label for="d4_correct_process">Was the correct process followed (confirm):</label>
                    <select name="d4[correct_process]" required>
                        <option value="Yes" <%= car && car.d4 && car.d4.correct_process === 'Yes' ? 'selected' : '' %>>Yes</option>
                        <option value="No" <%= car && car.d4 && car.d4.correct_process === 'No' ? 'selected' : '' %>>No</option>
                    </select>
                </div>
                <div>
                    <label for="d4_correct_process_info">Additional Info:</label>
                    <textarea name="d4[correct_process_info]" rows="3" placeholder="Enter additional information if needed"><%= car && car.d4 ? car.d4.correct_process_info : '' %></textarea>
                </div>

                <div>
                    <label for="d4_correct_tool">Was the correct tool used in the process (confirm):</label>
                    <select name="d4[correct_tool]" required>
                        <option value="Yes" <%= car && car.d4 && car.d4.correct_tool === 'Yes' ? 'selected' : '' %>>Yes</option>
                        <option value="No" <%= car && car.d4 && car.d4.correct_tool === 'No' ? 'selected' : '' %>>No</option>
                    </select>
                </div>
                <div>
                    <label for="d4_correct_tool_info">Additional Info:</label>
                    <textarea name="d4[correct_tool_info]" rows="3" placeholder="Enter additional information if needed"><%= car && car.d4 ? car.d4.correct_tool_info : '' %></textarea>
                </div>

                <div>
                    <label for="d4_correct_part_number">Was the correct Part Number used in the process (confirm):</label>
                    <select name="d4[correct_part_number]" required>
                        <option value="Yes" <%= car && car.d4 && car.d4.correct_part_number === 'Yes' ? 'selected' : '' %>>Yes</option>
                        <option value="No" <%= car && car.d4 && car.d4.correct_part_number === 'No' ? 'selected' : '' %>>No</option>
                    </select>
                </div>
                <div>
                    <label for="d4_correct_part_number_info">Additional Info:</label>
                    <textarea name="d4[correct_part_number_info]" rows="3" placeholder="Enter additional information if needed"><%= car && car.d4 ? car.d4.correct_part_number_info : '' %></textarea>
                </div>

                <!-- Continue with further problem-solving below -->

                <!-- Fish Bone Diagram -->
                <h3>Fish Bone Diagram</h3>

                <!-- People Section -->
                <div id="people-section">
                    <label for="d4_people">People:</label>
                    <div>
                        <input type="text" name="d4[people][]" placeholder="Enter People-related cause">
                        <button type="button" onclick="addInput('people-section', 'd4[people][]')">Add Another People Item</button>
                    </div>
                </div>

                <!-- Material Section -->
                <div id="material-section">
                    <label for="d4_material">Material:</label>
                    <div>
                        <input type="text" name="d4[material][]" placeholder="Enter Material-related cause">
                        <button type="button" onclick="addInput('material-section', 'd4[material][]')">Add Another Material Item</button>
                    </div>
                </div>

                <!-- Method Section -->
                <div id="method-section">
                    <label for="d4_method">Method:</label>
                    <div>
                        <input type="text" name="d4[method][]" placeholder="Enter Method-related cause">
                        <button type="button" onclick="addInput('method-section', 'd4[method][]')">Add Another Method Item</button>
                    </div>
                </div>

                <!-- Machine Section -->
                <div id="machine-section">
                    <label for="d4_machine">Machine:</label>
                    <div>
                        <input type="text" name="d4[machine][]" placeholder="Enter Machine-related cause">
                        <button type="button" onclick="addInput('machine-section', 'd4[machine][]')">Add Another Machine Item</button>
                    </div>
                </div>

                <!-- 5 Why Analysis -->
                <h3>5 Why Analysis</h3>
                <table>
                    <tr>
                        <th>Why</th>
                        <th>Cause</th>
                    </tr>
                    <tr>
                        <td>Why 1</td>
                        <td><input type="text" name="d4[why1]" style="width: 200%;" value="<%= car && car.d4 ? car.d4.why1 : '' %>"></td>
                    </tr>
                    <tr>
                        <td>Why 2</td>
                        <td><input type="text" name="d4[why2]" style="width: 200%;" value="<%= car && car.d4 ? car.d4.why2 : '' %>"></td>
                    </tr>
                    <tr>
                        <td>Why 3</td>
                        <td><input type="text" name="d4[why3]" style="width: 200%;" value="<%= car && car.d4 ? car.d4.why3 : '' %>"></td>
                    </tr>
                    <tr>
                        <td>Why 4</td>
                        <td><input type="text" name="d4[why4]" style="width: 200%;" value="<%= car && car.d4 ? car.d4.why4 : '' %>"></td>
                    </tr>
                    <tr>
                        <td>Why 5</td>
                        <td><input type="text" name="d4[why5]" style="width: 200%;" value="<%= car && car.d4 ? car.d4.why5 : '' %>"></td>
                    </tr>
                </table>

                <!-- Kepner Tregoe Questions -->
                <h3>Kepner Tregoe Questions</h3>
                <div>
                    <label for="d4_kt_eo">Changes via EO to the parts?:</label>
                    <input type="text" name="d4[kt_eo]" value="<%= car && car.d4 ? car.d4.kt_eo : '' %>">
                </div>
                <div>
                    <label for="d4_kt_pdr">Changes via PDR to the parts?:</label>
                    <input type="text" name="d4[kt_pdr]" value="<%= car && car.d4 ? car.d4.kt_pdr : '' %>">
                </div>
                <div>
                    <label for="d4_kt_4m">Changes via 4M to the parts?:</label>
                    <input type="text" name="d4[kt_4m]" value="<%= car && car.d4 ? car.d4.kt_4m : '' %>">
                </div>
                <div>
                    <label for="d4_kt_sw">Changes via Software to the parts?:</label>
                    <input type="text" name="d4[kt_sw]" value="<%= car && car.d4 ? car.d4.kt_sw : '' %>">
                </div>

                <!-- Trend and Extent -->
                <h3>Trend and Extent</h3>
                <div>
                    <label for="d4_trend">Trend?:</label>
                    <select name="d4[trend]">
                        <option value="Stable" <%= car && car.d4 && car.d4.trend === 'Stable' ? 'selected' : '' %>>Stable</option>
                        <option value="Increasing" <%= car && car.d4 && car.d4.trend === 'Increasing' ? 'selected' : '' %>>Increasing</option>
                        <option value="Decreasing" <%= car && car.d4 && car.d4.trend === 'Decreasing' ? 'selected' : '' %>>Decreasing</option>
                    </select>
                </div>
                <div>
                    <label for="d4_extent">Extent?:</label>
                    <select name="d4[extent]">
                        <option value="Spike" <%= car && car.d4 && car.d4.extent === 'Spike' ? 'selected' : '' %>>Spike</option>
                        <option value="Sporadic" <%= car && car.d4 && car.d4.extent === 'Sporadic' ? 'selected' : '' %>>Sporadic</option>
                        <option value="Cycles" <%= car && car.d4 && car.d4.extent === 'Cycles' ? 'selected' : '' %>>Cycles</option>
                    </select>
                </div>

                <!-- Save Button -->
                <button type="submit" name="action" value="save">Save</button>
            </form>
        </div>

        <!-- D5 Section: Potential Corrective Action -->
        <div id="d5" class="section">
            <h2>D5: Potential Corrective Action</h2>

            <!-- Note -->
            <p style="font-size: 10px;">Will the Corrective Action(s) solve the problem for the customer?</p>

            <form action="<%= car ? `/save-section/${car._id}/d5` : '/save-section/new/d5' %>" method="POST" enctype="multipart/form-data">
                <!-- Who is the customer? -->
                <div>
                    <label for="d5_customer">Who is the customer?:</label>
                    <input type="text" id="d5_customer" name="d5[customer]" value="<%= car && car.d5 ? car.d5.customer : '' %>">
                </div>

                <!-- Capability Study -->
                <div>
                    <label for="d5_capability_study">Capability Study:</label>
                    <input type="file" id="d5_capability_study" name="d5_capability_study_upload" accept=".pdf,.doc,.docx,.xlsx,.xls">
                </div>

                <!-- Control Chart -->
                <div>
                    <label for="d5_control_chart">Control Chart:</label>
                    <input type="file" id="d5_control_chart" name="d5_control_chart_upload" accept=".pdf,.doc,.docx,.xlsx,.xls">
                </div>

                <!-- Gage R&R -->
                <div>
                    <label for="d5_gage_rr">Gage R&R:</label>
                    <input type="file" id="d5_gage_rr" name="d5_gage_rr_upload" accept=".pdf,.doc,.docx,.xlsx,.xls">
                </div>

                <!-- Risk Assessment -->
                <div>
                    <label for="d5_risk_assessment">Risk Assessment:</label>
                    <input type="file" id="d5_risk_assessment" name="d5_risk_assessment_upload" accept=".pdf,.doc,.docx,.xlsx,.xls">
                </div>

                <!-- Any major clues in the data uploaded? -->
                <div>
                    <label for="d5_clues_in_data">Any major clues in the data uploaded?:</label>
                    <input type="text" id="d5_clues_in_data" name="d5[clues_in_data]" value="<%= car && car.d5 ? car.d5.clues_in_data : '' %>">
                </div>

                <!-- What control factors have the most influence on the Response? -->
                <div>
                    <label for="d5_control_factors_influence">What control factors have the most influence on the Response?:</label>
                    <input type="text" id="d5_control_factors_influence" name="d5[control_factors_influence]" value="<%= car && car.d5 ? car.d5.control_factors_influence : '' %>">
                </div>

                <!-- Any other control factors have influence on the Response? -->
                <div>
                    <label for="d5_other_control_factors">Any other control factors have influence on the Response?:</label>
                    <input type="text" id="d5_other_control_factors" name="d5[other_control_factors]" value="<%= car && car.d5 ? car.d5.other_control_factors : '' %>">
                </div>

                <!-- What Noise factors have an influence? -->
                <div>
                    <label for="d5_noise_factors">What Noise factors have an influence? (e.g., temperature, time):</label>
                    <input type="text" id="d5_noise_factors" name="d5[noise_factors]" value="<%= car && car.d5 ? car.d5.noise_factors : '' %>">
                </div>

                <!-- Corrective Actions -->
                <div>
                    <label for="d5_corrective_action">Corrective Action:</label>
                    <input type="text" id="d5_corrective_action" name="d5[corrective_action]" value="<%= car && car.d5 ? car.d5.corrective_action : '' %>">
                </div>

                <!-- Potential 2nd Corrective Action -->
                <div>
                    <label for="d5_corrective_action_2">Potential 2nd Corrective Action:</label>
                    <input type="text" id="d5_corrective_action_2" name="d5[corrective_action_2]" value="<%= car && car.d5 ? car.d5.corrective_action_2 : '' %>">
                </div>

                <!-- Potential 3rd Corrective Action -->
                <div>
                    <label for="d5_corrective_action_3">Potential 3rd Corrective Action:</label>
                    <input type="text" id="d5_corrective_action_3" name="d5[corrective_action_3]" value="<%= car && car.d5 ? car.d5.corrective_action_3 : '' %>">
                </div>

                <!-- ECR -->
                <div>
                    <label for="d5_ecr">ECR:</label>
                    <input type="text" id="d5_ecr" name="d5[ecr]" value="<%= car && car.d5 ? car.d5.ecr : '' %>">
                </div>

                <!-- EO -->
                <div>
                    <label for="d5_eo">EO:</label>
                    <input type="text" id="d5_eo" name="d5[eo]" value="<%= car && car.d5 ? car.d5.eo : '' %>">
                </div>

                <!-- Save Button -->
                <button type="submit" name="action" value="save">Save</button>
            </form>
        </div>

        <!-- D6 Section: Implement Corrective Action -->
        <div id="d6" class="section">
            <h2>D6: Implement Corrective Action</h2>
            <form action="<%= car ? `/save-section/${car._id}/d6` : '/save-section/new/d6' %>" method="POST" enctype="multipart/form-data">
                <!-- Describe the Trial -->
                <div>
                    <label for="d6_trial_description">Describe the Trial:</label>
                    <textarea name="d6[trial_description]" id="d6_trial_description" rows="3" placeholder="Describe the trial"><%= car && car.d6 ? car.d6.trial_description : '' %></textarea>
                </div>

                <!-- How has the improvement affected FTTQ? -->
                <div>
                    <label for="d6_fttq_effect">How has the improvement affected FTTQ?:</label>
                    <textarea name="d6[fttq_effect]" id="d6_fttq_effect" rows="3" placeholder="Describe the effect on FTTQ, if applicable"><%= car && car.d6 ? car.d6.fttq_effect : '' %></textarea>
                </div>

                <!-- How has the improvement affected Dealer Claims or 3M? -->
                <div>
                    <label for="d6_dealer_claims_effect">How has the improvement affected Dealer Claims or 3M?:</label>
                    <textarea name="d6[dealer_claims_effect]" id="d6_dealer_claims_effect" rows="3" placeholder="Describe the effect on Dealer Claims or 3M, if applicable"><%= car && car.d6 ? car.d6.dealer_claims_effect : '' %></textarea>
                </div>

                <!-- Other KPIs -->
                <div>
                    <label for="d6_other_kpis">Other KPIs:</label>
                    <textarea name="d6[other_kpis]" id="d6_other_kpis" rows="3" placeholder="Enter other KPIs, if applicable"><%= car && car.d6 ? car.d6.other_kpis : '' %></textarea>
                </div>

                <!-- Any issues with corrective action? -->
                <div>
                    <label for="d6_corrective_action_issues">Any issues with corrective action?:</label>
                    <textarea name="d6[corrective_action_issues]" id="d6_corrective_action_issues" rows="3" placeholder="Describe any issues with corrective action"><%= car && car.d6 ? car.d6.corrective_action_issues : '' %></textarea>
                </div>

                <!-- Upload Control Plans -->
                <div>
                    <label for="d6_control_plans">Upload Control Plans:</label>
                    <input type="file" id="d6_control_plans" name="d6_control_plans_upload" accept=".pdf,.doc,.docx,.xlsx,.xls">
                </div>

                <!-- Upload FMEAs -->
                <div>
                    <label for="d6_fmeas">Upload FMEAs:</label>
                    <input type="file" id="d6_fmeas" name="d6_fmeas_upload" accept=".pdf,.doc,.docx,.xlsx,.xls">
                </div>

                <!-- Poka-Yoke (Any error proofing opportunities?) -->
                <div>
                    <label for="d6_poka_yoke">Poka-Yoke (Any error proofing opportunities?):</label>
                    <textarea name="d6[poka_yoke]" id="d6_poka_yoke" rows="3" placeholder="Describe any error proofing opportunities"><%= car && car.d6 ? car.d6.poka_yoke : '' %></textarea>
                </div>

                <!-- Production Instructions Needed -->
                <div>
                    <label for="d6_production_instructions_needed">Production Instructions Needed:</label>
                    <select name="d6[production_instructions_needed]" id="d6_production_instructions_needed">
                        <option value="Yes" <%= car && car.d6 && car.d6.production_instructions_needed === 'Yes' ? 'selected' : '' %>>Yes</option>
                        <option value="No" <%= car && car.d6 && car.d6.production_instructions_needed === 'No' ? 'selected' : '' %>>No</option>
                    </select>
                </div>

                <!-- Production Instructions Number -->
                <div>
                    <label for="d6_production_instructions_number">Production Instructions Number:</label>
                    <input type="text" id="d6_production_instructions_number" name="d6[production_instructions_number]" value="<%= car && car.d6 ? car.d6.production_instructions_number : '' %>">
                </div>

                <!-- Production Instructions Trial Date -->
                <div>
                    <label for="d6_production_instructions_trial_date">Production Instructions Trial Date:</label>
                    <input type="date" id="d6_production_instructions_trial_date" name="d6[production_instructions_trial_date]" value="<%= car && car.d6 ? car.d6.production_instructions_trial_date : '' %>">
                </div>

                <!-- Save Button -->
                <button type="submit" name="action" value="save">Save</button>
            </form>
        </div>

        <!-- D7 Section: Take Preventive Action -->
        <div id="d7" class="section">
            <h2>D7: Take Preventive Action</h2>
            <form action="<%= car ? `/save-section/${car._id}/d7` : '/save-section/new/d7' %>" method="POST" enctype="multipart/form-data">
                <!-- What documents need to be updated? -->
                <div>
                    <label for="d7_documents_update">What documents need to be updated?:</label>
                    <textarea name="d7[documents_update]" id="d7_documents_update" rows="3" placeholder="List the documents that need to be updated"><%= car && car.d7 ? car.d7.documents_update : '' %></textarea>
                </div>

                <!-- Upload DFMEA -->
                <div>
                    <label for="d7_dfmea">Upload DFMEA:</label>
                    <input type="file" id="d7_dfmea" name="dfmea_upload" accept=".pdf,.doc,.docx,.xlsx,.xls">
                </div>

                <!-- Upload PFMEA -->
                <div>
                    <label for="d7_pfmea">Upload PFMEA:</label>
                    <input type="file" id="d7_pfmea" name="pfmea_upload" accept=".pdf,.doc,.docx,.xlsx,.xls">
                </div>

                <!-- Upload SWIS -->
                <div>
                    <label for="d7_swis">Upload SWIS:</label>
                    <input type="file" id="d7_swis" name="swis_upload" accept=".pdf,.doc,.docx,.xlsx,.xls">
                </div>

                <!-- Preventive Actions -->
                <div>
                    <label for="d7_preventive_actions">Describe Preventive Actions:</label>
                    <textarea name="d7[preventive_actions]" id="d7_preventive_actions" rows="3" placeholder="Describe the preventive actions taken"><%= car && car.d7 ? car.d7.preventive_actions : '' %></textarea>
                </div>

                <!-- Save Button -->
                <button type="submit" name="action" value="save">Save</button>
            </form>
        </div>

        <!-- D8 Section: Read Across & Lessons Learned -->
        <div id="d8" class="section">
            <h2>D8: Read Across & Lessons Learned</h2>
            <form action="<%= car ? `/save-section/${car._id}/d8` : '/save-section/new/d8' %>" method="POST" enctype="multipart/form-data">
                <!-- Read Across & Lessons Learned -->
                <div>
                    <label for="d8_read_across">Read Across & Lessons Learned:</label>
                    <textarea name="d8[read_across]" id="d8_read_across" rows="5" placeholder="Enter lessons learned and read across details"><%= car && car.d8 ? car.d8.read_across : '' %></textarea>
                </div>

                <!-- Other Vehicles Potentially Affected -->
                <div>
                    <label for="d8_other_vehicles_affected">Other Vehicles Potentially Affected?:</label>
                    <select name="d8[other_vehicles_affected]" id="d8_other_vehicles_affected">
                        <option value="NQ5a" <%= car && car.d8 && car.d8.other_vehicles_affected === 'NQ5a' ? 'selected' : '' %>>NQ5a</option>
                        <option value="MQ4a" <%= car && car.d8 && car.d8.other_vehicles_affected === 'MQ4a' ? 'selected' : '' %>>MQ4a</option>
                        <option value="ON" <%= car && car.d8 && car.d8.other_vehicles_affected === 'ON' ? 'selected' : '' %>>ON</option>
                        <option value="MV1A" <%= car && car.d8 && car.d8.other_vehicles_affected === 'MV1A' ? 'selected' : '' %>>MV1A</option>
                        <option value="CV1A" <%= car && car.d8 && car.d8.other_vehicles_affected === 'CV1A' ? 'selected' : '' %>>CV1A</option>
                        <option value="Other" <%= car && car.d8 && car.d8.other_vehicles_affected === 'Other' ? 'selected' : '' %>>Other</option>
                    </select>
                    <button type="button" onclick="addVehicle()">Add Another Vehicle</button>
                    <div id="additional_vehicles"></div>
                </div>

                <!-- Previous AMPs -->
                <div>
                    <label for="d8_previous_amps">Previous AMPs:</label>
                    <input type="file" id="d8_previous_amps" name="d8_previous_amps_upload" accept=".pdf,.doc,.docx,.xlsx,.xls">
                </div>

                <!-- Previous Line Call Sheets -->
                <div>
                    <label for="d8_previous_line_call_sheets">Previous Line Call Sheets:</label>
                    <input type="file" id="d8_previous_line_call_sheets" name="d8_previous_line_call_sheets_upload" accept=".pdf,.doc,.docx,.xlsx,.xls">
                </div>

                <!-- Save Button -->
                <button type="submit" name="action" value="save">Save</button>
            </form>
        </div>
    </div>

    <script>
        function showSection(sectionId) {
            console.log(`Attempting to show section: ${sectionId}`);
            
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
                console.log(`Hiding section: ${section.id}`);
            });
    
            // Show the selected section
            const selectedSection = document.getElementById(sectionId);
            if (selectedSection) {
                selectedSection.classList.add('active');
                selectedSection.style.display = 'block';
                console.log(`Showing section: ${sectionId}`);
            } else {
                console.error(`Section with ID ${sectionId} not found.`);
            }
        }
    
        // Automatically show the first section by default
        document.addEventListener("DOMContentLoaded", function() {
            showSection('d1'); // Show D1 by default
        });
    </script>
    
    <script>
        function previewPhotos() {
            const previewContainer = document.getElementById('photo-preview');
            const files = document.getElementById('photos').files;
            previewContainer.innerHTML = ''; // Clear any previous previews

            if (files.length > 0) {
                const firstFile = files[0];
                const reader = new FileReader();

                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.width = '150px';
                    img.style.height = '150px';
                    previewContainer.appendChild(img);
                };

                reader.readAsDataURL(firstFile);
            }
        }

        function addInput(sectionId, name) {
            const section = document.getElementById(sectionId);
            const inputDiv = document.createElement('div');
            inputDiv.innerHTML = `<input type="text" name="${name}" placeholder="Enter another cause">`;
            section.appendChild(inputDiv);
        }

        function addMember() {
            const memberCount = document.querySelectorAll('#additional_members input').length + 1;
            const div = document.createElement('div');
            div.innerHTML = `<label for="member_${memberCount}">Additional Team Member ${memberCount}:</label>
                <input type="text" id="member_${memberCount}" name="team_members[additional_member_${memberCount}]" placeholder="Enter first and last name">`;
            document.getElementById('additional_members').appendChild(div);
        }

        let vehicleCount = 1;
        function addVehicle() {
            if (vehicleCount < 5) { // Limit to 5 additional vehicles
                vehicleCount++;
                const div = document.createElement('div');
                div.innerHTML = `<label for="additional_vehicle_${vehicleCount}">Additional Vehicle ${vehicleCount}:</label>
                            <select name="d8[additional_vehicle_${vehicleCount}]" id="additional_vehicle_${vehicleCount}">
                                <option value="NQ5a">NQ5a</option>
                                <option value="MQ4a">MQ4a</option>
                                <option value="ON">ON</option>
                                <option value="MV1A">MV1A</option>
                                <option value="CV1A">CV1A</option>
                                <option value="Other">Other</option>
                            </select>`;
                document.getElementById('additional_vehicles').appendChild(div);
            } else {
                alert('You can only add up to 5 additional vehicles.');
            }
        }

        function submitForm(action) {
            const form = document.getElementById('d1-form');
            if (action === 'save') {
                form.action = '/save-d1/<%= car ? car._id : "" %>';
            } else if (action === 'submit') {
                form.action = '/submit-d1';
            }

            form.submit();
        }
    </script>
</body>
</html>
